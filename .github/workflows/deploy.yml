name: Deploy to EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        script: |
          # Navigate to app directory
          cd /home/ec2-user/app

          # Stop existing application
          pm2 stop all || true

          # Remove old code
          rm -rf DevOps-Agent

          # Clone latest code
          git clone https://github.com/shittuay/DevOps-Agent.git
          cd DevOps-Agent

          # Check if package.json exists and install dependencies
          if [ -f "package.json" ]; then
            npm install
            # Build if build script exists
            npm run build --if-present
            # Start with PM2
            pm2 start npm --name "devops-agent" -- start
          else
            # For Python applications
            if [ -f "requirements.txt" ]; then
              pip3 install -r requirements.txt
              # Start Python app (adjust as needed)
              pm2 start "python3 app.py" --name "devops-agent"
            else
              echo "No package.json or requirements.txt found. Please configure manually."
            fi
          fi

          # Save PM2 configuration
          pm2 save
          pm2 startup

          echo "‚úÖ Deployment completed successfully!"
          echo "üåê Your app should be accessible at: http://3.91.154.244"
