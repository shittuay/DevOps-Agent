name: Deploy to EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        script: |
          set -e

          echo "ðŸš€ Starting DevOps Agent Deployment..."

          # Set deployment directory
          DEPLOY_DIR="/home/ec2-user/app/DevOps-Agent"

          # Navigate to deployment directory
          cd /home/ec2-user/app

          # Stop existing PM2 processes
          echo "â¸ï¸  Stopping existing processes..."
          pm2 stop devops-agent 2>/dev/null || true
          pm2 delete devops-agent 2>/dev/null || true

          # Remove old code
          echo "ðŸ—‘ï¸  Removing old code..."
          rm -rf DevOps-Agent

          # Clone fresh code
          echo "ðŸ“¥ Cloning latest code..."
          git clone https://github.com/shittuay/DevOps-Agent.git
          cd DevOps-Agent

          # Install Python dependencies
          echo "ðŸ“¦ Installing dependencies..."
          pip3 install --user -r requirements.txt

          # Create necessary directories
          mkdir -p logs instance config

          # Create or update .env file
          echo "âš™ï¸  Configuring environment..."
          cat > config/.env << 'ENVEOF'
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          DATABASE_URL=sqlite:///devops_agent.db
          FLASK_ENV=production
          ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }}
          PORT=5000
          HOST=0.0.0.0
          LOG_LEVEL=INFO
          ENVEOF

          # Initialize database
          echo "ðŸ—„ï¸  Initializing database..."
          python3 -c "from app import app, db; app.app_context().push(); db.create_all()" || echo "Database already initialized"

          # Start the application with PM2
          echo "ðŸš€ Starting application..."
          pm2 start app.py --name devops-agent --interpreter python3

          # Save PM2 configuration
          pm2 save

          # Check status
          pm2 status devops-agent

          echo ""
          echo "âœ… Deployment completed successfully!"
          echo "ðŸŒ Your app is accessible at: http://3.91.154.244:5000"
