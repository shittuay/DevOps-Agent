# Penetration Testing Features Guide

## Overview

The DevOps Agent now includes comprehensive penetration testing capabilities to help security professionals assess the security posture of their infrastructure. This guide covers installation, configuration, and usage of all penetration testing features.

**IMPORTANT: Only use these tools on systems you own or have explicit written authorization to test. Unauthorized penetration testing is illegal.**

## Table of Contents

1. [Features](#features)
2. [Installation](#installation)
3. [Configuration](#configuration)
4. [Safety Controls](#safety-controls)
5. [Tool Categories](#tool-categories)
6. [Usage Examples](#usage-examples)
7. [Best Practices](#best-practices)
8. [Troubleshooting](#troubleshooting)

---

## Features

The penetration testing suite includes four major categories:

### 1. Network Scanning
- Port scanning with Nmap
- Service version detection
- OS fingerprinting
- Network discovery

### 2. Vulnerability Scanning
- Web server vulnerability scanning (Nikto)
- SSL/TLS configuration testing
- Security misconfiguration detection

### 3. Web Application Testing
- SQL injection testing (SQLmap)
- Cross-Site Scripting (XSS) detection
- OWASP ZAP spider integration
- Web application vulnerability assessment

### 4. Cloud Security Auditing
- AWS security posture assessment
- Azure security configuration review
- GCP security audit
- Kubernetes cluster security validation

---

## Installation

### Prerequisites

1. **Python 3.10+** installed
2. **DevOps Agent** base installation completed
3. **External Security Tools** (optional but recommended):

```bash
# Ubuntu/Debian
sudo apt-get update
sudo apt-get install -y nmap nikto sslscan

# macOS
brew install nmap nikto sslscan

# SQLmap (cross-platform)
git clone --depth 1 https://github.com/sqlmapproject/sqlmap.git ~/sqlmap
ln -s ~/sqlmap/sqlmap.py /usr/local/bin/sqlmap

# XSStrike (optional)
git clone https://github.com/s0md3v/XSStrike.git ~/XSStrike
pip install -r ~/XSStrike/requirements.txt
```

### Install Python Dependencies

```bash
cd devops-agent
pip install -r requirements.txt
```

The following pentest-specific packages will be installed:
- `python-nmap==0.7.1` - Python wrapper for Nmap
- `scapy==2.5.0` - Packet manipulation library
- `boto3` - AWS SDK (for cloud security audits)
- `kubernetes` - Kubernetes client (for K8s security audits)

---

## Configuration

### 1. Enable Penetration Testing

Edit `config/config.yaml`:

```yaml
pentest:
  enabled: true
  require_confirmation: true
  max_scan_intensity: 4
  prohibited_scan_types:
    - "dos"
    - "flood"
    - "exploit"
  whitelisted_targets:
    - "192.168.1.0/24"      # Your local network
    - "10.0.0.0/8"           # Private network
    - "localhost"
    - "127.0.0.1"
    - "example.com"          # Your authorized domain
    - "203.0.113.0/24"       # Specific IP range
  audit_log_file: "logs/pentest_audit.log"

  tools:
    nmap:
      enabled: true
      max_timeout_seconds: 1800
    nikto:
      enabled: true
    sqlmap:
      enabled: true
      max_risk_level: 2
    xss_scanner:
      enabled: true
    ssl_scanner:
      enabled: true

  cloud_audit:
    aws:
      enabled: true
      regions: ["us-east-1", "us-west-2"]
    azure:
      enabled: false
    gcp:
      enabled: false
    kubernetes:
      enabled: true
```

### 2. Target Whitelisting

**CRITICAL**: Configure your authorized targets in the `whitelisted_targets` list.

- **CIDR notation**: `192.168.1.0/24` allows the entire subnet
- **IP addresses**: `203.0.113.45` allows a specific IP
- **Hostnames**: `testserver.example.com` allows a specific host
- **Domains**: Substring matching (e.g., `example.com` matches `*.example.com`)

**If no whitelist is configured, all targets are allowed (assumes you have authorization).**

### 3. Environment Variables

Create or update `.env`:

```bash
# AWS credentials for cloud security audits
AWS_ACCESS_KEY_ID=your_access_key
AWS_SECRET_ACCESS_KEY=your_secret_key
AWS_DEFAULT_REGION=us-east-1

# Azure credentials (optional)
AZURE_SUBSCRIPTION_ID=your_subscription_id

# GCP credentials (optional)
GOOGLE_APPLICATION_CREDENTIALS=/path/to/service-account.json
```

---

## Safety Controls

The DevOps Agent implements multiple layers of safety controls:

### 1. Authorization Validation

- All pentest tools validate targets against the whitelist
- Unauthorized targets are blocked before any scanning occurs
- Clear error messages indicate why a target was blocked

### 2. Confirmation Requirements

When `require_confirmation: true` (default):
- Agent will ask for explicit confirmation before running scans
- Shows target, scan type, and potential impact
- User must approve each operation

### 3. Scan Scope Limitations

- **Intensity limits**: Maximum scan intensity capped (default: 4/5)
- **Risk levels**: SQLmap limited to risk level 2 to prevent service disruption
- **Prohibited types**: DoS, flood, and exploit scans blocked by default
- **Timeouts**: All scans have maximum execution time limits

### 4. Audit Logging

All penetration testing activities are logged:

```json
{
  "timestamp": "2025-11-22 14:30:45",
  "operation": "nmap_port_scan",
  "target": "192.168.1.100",
  "parameters": {"scan_type": "syn", "ports": "1-1000"},
  "success": true,
  "findings_count": 5,
  "execution_time_ms": 12453
}
```

Logs are stored in:
- **Standard log**: `logs/agent.log`
- **Pentest audit log**: `logs/pentest_audit.log`
- **Security log**: `logs/security.log`

---

## Tool Categories

### Network Scanning Tools

#### nmap_port_scan

Scan network hosts for open ports and services.

**Parameters:**
- `target` (required): IP address or hostname
- `ports`: Port specification (default: "1-1000")
  - Range: `"1-1000"`
  - Specific: `"22,80,443,8080"`
  - All: `"all"`
- `scan_type`: Scan technique (default: "syn")
  - `"syn"`: SYN stealth scan (requires root)
  - `"tcp"`: TCP connect scan
  - `"udp"`: UDP scan
  - `"service"`: Service version detection
- `timing`: Speed template 0-5 (default: 3)
  - 0: Paranoid (slowest, stealthiest)
  - 3: Normal
  - 5: Insane (fastest, noisiest)

**Example:**
```
Scan the web server at 192.168.1.50 for common web ports
```

#### nmap_service_detection

Detect service versions and operating system.

**Parameters:**
- `target` (required): IP address or hostname
- `ports`: Port specification
- `aggressive`: Enable aggressive scanning (-A flag)

**Example:**
```
Perform service detection on 10.0.0.15
```

---

### Vulnerability Scanning Tools

#### nikto_web_scan

Scan web servers for known vulnerabilities.

**Parameters:**
- `target_url` (required): Web server URL
- `ssl`: Force SSL mode (default: false)
- `tuning`: Scan categories
  - `"1"`: Interesting files
  - `"2"`: Misconfigurations
  - `"3"`: Information disclosure

**Example:**
```
Run a Nikto scan on https://testapp.example.com
```

#### ssl_scan

Test SSL/TLS configuration for weaknesses.

**Parameters:**
- `target` (required): Hostname or IP
- `port`: SSL/TLS port (default: 443)

**Example:**
```
Check SSL configuration for mail.example.com on port 465
```

---

### Web Application Testing Tools

#### sqlmap_scan

Test for SQL injection vulnerabilities.

**Parameters:**
- `target_url` (required): URL to test
- `data`: POST data string
- `cookie`: Cookie for authentication
- `risk_level`: Risk level 1-2 (limited for safety)
- `batch`: Run without user interaction (default: true)

**Example:**
```
Test https://webapp.example.com/login.php?id=1 for SQL injection
```

#### xss_scan

Test for Cross-Site Scripting vulnerabilities.

**Parameters:**
- `target_url` (required): URL to test
- `parameters`: Specific parameters to test

**Example:**
```
Scan https://webapp.example.com/search for XSS vulnerabilities
```

#### zap_spider_scan

Spider web application to discover URLs.

**Parameters:**
- `target_url` (required): Starting URL
- `max_depth`: Maximum crawl depth (default: 5)

**Example:**
```
Spider https://testapp.example.com to map the application
```

---

### Cloud Security Auditing Tools

#### aws_security_audit

Audit AWS security posture.

**Parameters:**
- `region`: AWS region (default: all regions)
- `services`: Services to audit (default: all)
  - Options: `["s3", "ec2", "iam", "rds", "lambda", "cloudtrail"]`

**Checks performed:**
- S3 buckets with public access
- Unencrypted S3 buckets
- S3 buckets without versioning
- Security groups allowing 0.0.0.0/0
- IAM access keys older than 90 days
- Root account usage

**Example:**
```
Audit AWS security in us-east-1 region for S3 and EC2
```

#### azure_security_audit

Audit Azure security configuration.

**Parameters:**
- `subscription_id`: Azure subscription ID
- `resource_groups`: Specific resource groups to audit

**Example:**
```
Audit Azure subscription security
```

#### gcp_security_audit

Audit GCP security posture.

**Parameters:**
- `project_id`: GCP project ID
- `services`: Services to audit

**Example:**
```
Audit GCP project myproject-12345 security
```

#### kubernetes_security_audit

Audit Kubernetes cluster security.

**Parameters:**
- `namespace`: Namespace to audit (default: all namespaces)
- `context`: Kubernetes context to use

**Checks performed:**
- Containers running as root (UID 0)
- Writable root filesystems
- Privileged containers
- Public LoadBalancer services
- Security context violations

**Example:**
```
Audit Kubernetes security for namespace production
```

---

## Usage Examples

### Example 1: Network Discovery

```
User: "I need to scan my local network 192.168.1.0/24 to find all devices and open ports"

Agent: I'll help you scan your local network. Since this is a pentest operation,
I need to confirm:

Target: 192.168.1.0/24
Operation: Network port scan
Expected duration: 5-10 minutes

Do you want to proceed? [yes/no]

User: yes

Agent: [Executes nmap scan]

Found 15 active hosts on 192.168.1.0/24:
- 192.168.1.1: Router (ports 80, 443)
- 192.168.1.10: Web server (ports 22, 80, 443, 3306)
- 192.168.1.20: Workstation (port 22)
...
```

### Example 2: Web Application Security Assessment

```
User: "Test my test application at https://testapp.local for vulnerabilities"

Agent: I'll perform a comprehensive security assessment. This will include:
1. Nikto web server scan
2. SSL/TLS configuration check
3. SQL injection testing
4. XSS vulnerability scan

Target is in whitelist. Proceeding...

Results:
- Nikto: Found 3 potential issues (outdated Apache version, directory listing)
- SSL Scan: Grade A, but TLS 1.0 still enabled (recommend disabling)
- SQLmap: No SQL injection found
- XSS: Potential reflected XSS in search parameter

Recommendations:
1. Upgrade Apache to latest version
2. Disable directory listing
3. Disable TLS 1.0 and TLS 1.1
4. Sanitize search parameter input
```

### Example 3: AWS Security Audit

```
User: "Audit the security of my AWS infrastructure"

Agent: Running AWS security audit across all regions...

Critical Findings (2):
- S3 bucket "company-backups" is publicly accessible
- Security group sg-abc123 allows SSH (port 22) from 0.0.0.0/0

High Findings (5):
- S3 bucket "logs-bucket" has no encryption
- IAM user "jenkins" has access key 245 days old
- Security group sg-def456 allows RDP from 0.0.0.0/0
...

Recommendations:
1. Immediately restrict public S3 bucket access
2. Limit SSH access to specific IP ranges
3. Enable S3 bucket encryption
4. Rotate IAM access keys
```

### Example 4: Kubernetes Security Check

```
User: "Check my Kubernetes cluster for security issues"

Agent: Scanning Kubernetes cluster across all namespaces...

Critical Issues (1):
- Pod "admin-debug" running privileged container in namespace "default"

High Issues (3):
- Pod "webapp-frontend" running as root (UID 0)
- Pod "api-backend" has writable root filesystem
- Service "internal-api" exposed via LoadBalancer

Recommendations:
1. Remove privileged mode from admin-debug pod
2. Configure runAsUser to non-root UID
3. Enable readOnlyRootFilesystem: true
4. Review if LoadBalancer exposure is necessary
```

---

## Best Practices

### 1. Authorization and Legal Compliance

- **Always obtain written authorization** before testing
- Test only systems you own or have explicit permission to test
- Keep authorization documentation for legal protection
- Understand local laws regarding security testing
- For penetration testing engagements, have a clear scope document

### 2. Target Whitelisting

- Maintain an up-to-date whitelist in config.yaml
- Use CIDR notation for network ranges
- Remove targets from whitelist when testing is complete
- Never disable the whitelist in production environments
- Document why each target is whitelisted

### 3. Scan Timing and Intensity

- Run intensive scans during maintenance windows
- Start with low-intensity scans (timing: 2-3)
- Increase intensity only if needed
- Be aware that aggressive scans may trigger IDS/IPS
- Consider the impact on production systems

### 4. Result Documentation

- Review all scan results thoroughly
- Document findings with severity ratings
- Create remediation plans for discovered issues
- Retest after fixes are applied
- Keep audit logs for compliance

### 5. Cloud Security Audits

- Run cloud audits regularly (weekly/monthly)
- Monitor for new security findings
- Integrate with CI/CD for continuous security
- Export findings to ticketing systems
- Track remediation progress

### 6. Responsible Disclosure

- If you find vulnerabilities in third-party systems, follow responsible disclosure
- Give vendors reasonable time to fix issues
- Don't publicly disclose until patches are available
- Follow industry-standard disclosure timelines (typically 90 days)

---

## Troubleshooting

### Tool Not Found Errors

**Error**: `nmap not installed`

**Solution**:
```bash
# Ubuntu/Debian
sudo apt-get install nmap

# macOS
brew install nmap
```

### Permission Denied

**Error**: `Permission denied when running SYN scan`

**Solution**: SYN scans require root/administrator privileges:
```bash
# Linux
sudo python main.py interactive

# Or use TCP connect scan instead (no root required)
# In your prompt: "Use TCP scan instead of SYN scan"
```

### Target Not Authorized

**Error**: `Target not in whitelist: 203.0.113.50`

**Solution**: Add the target to `config/config.yaml`:
```yaml
pentest:
  whitelisted_targets:
    - "203.0.113.50"  # Add specific IP
    # OR
    - "203.0.113.0/24"  # Add entire subnet
```

### AWS Credentials Error

**Error**: `Unable to locate credentials`

**Solution**: Configure AWS credentials:
```bash
# Option 1: Environment variables
export AWS_ACCESS_KEY_ID=your_key
export AWS_SECRET_ACCESS_KEY=your_secret

# Option 2: AWS CLI configuration
aws configure

# Option 3: .env file
echo "AWS_ACCESS_KEY_ID=your_key" >> .env
echo "AWS_SECRET_ACCESS_KEY=your_secret" >> .env
```

### Kubernetes Connection Error

**Error**: `Unable to connect to Kubernetes cluster`

**Solution**: Verify kubeconfig:
```bash
# Check current context
kubectl config current-context

# Verify connection
kubectl get nodes

# Update config path in config.yaml if needed
kubernetes:
  kubeconfig: "/path/to/your/kubeconfig"
```

### Scan Timeout

**Error**: `Scan timed out after 30 minutes`

**Solution**:
- Reduce scan scope (fewer ports, specific targets)
- Increase timeout in config:
```yaml
pentest:
  tools:
    nmap:
      max_timeout_seconds: 3600  # 1 hour
```
- Use faster timing template (but less stealthy)

### SQLmap Batch Mode Issues

**Error**: SQLmap asking for input despite batch mode

**Solution**: Ensure batch parameter is true:
```python
# The agent automatically sets batch=True
# If issues persist, check sqlmap installation
sqlmap --version
```

---

## Security Considerations

### Data Handling

- Scan results may contain sensitive information
- Store results securely with appropriate access controls
- Encrypt sensitive scan data at rest
- Securely delete old scan results
- Don't commit scan results to version control

### Network Impact

- Scans generate network traffic that may be logged
- Aggressive scans can impact network performance
- Coordinate with network teams before scanning
- Monitor network during scans
- Have rollback plans for production testing

### False Positives

- Not all findings are true vulnerabilities
- Verify findings manually before remediation
- Understand the context of each finding
- Some findings may be acceptable risks
- Document accepted risks and compensating controls

---

## Integration with CI/CD

### Automated Security Scanning

Add pentest checks to your deployment pipeline:

```yaml
# .github/workflows/security-scan.yml
name: Security Scan
on:
  push:
    branches: [main]
  schedule:
    - cron: '0 0 * * 0'  # Weekly

jobs:
  security-audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Run AWS Security Audit
        run: |
          python main.py ask "Audit AWS security and report findings"
      - name: Run K8s Security Check
        run: |
          python main.py ask "Check Kubernetes cluster security"
```

---

## Support and Resources

### Documentation
- Main README: `README.md`
- Configuration Guide: `config/config.yaml.example`
- API Documentation: Check tool docstrings in `src/tools/pentest_tools.py`

### External Resources
- Nmap: https://nmap.org/book/man.html
- Nikto: https://github.com/sullo/nikto
- SQLmap: https://github.com/sqlmapproject/sqlmap
- OWASP: https://owasp.org/
- OWASP ZAP: https://www.zaproxy.org/

### Reporting Issues
- GitHub Issues: https://github.com/your-org/devops-agent/issues
- Include: Tool used, target (sanitized), error messages, configuration

---

## Changelog

### Version 1.1.0 (Current)
- Initial penetration testing features
- Network scanning with Nmap
- Vulnerability scanning with Nikto
- Web app testing (SQLmap, XSS)
- Cloud security auditing (AWS, Azure, GCP, K8s)
- Target whitelisting and authorization controls
- Comprehensive audit logging
- Safety validators and confirmations

---

## License and Disclaimer

**DISCLAIMER**: This software is provided for authorized security testing only.
Users are solely responsible for obtaining proper authorization before testing
any systems. Unauthorized access to computer systems is illegal. The developers
assume no liability for misuse of this software.

**Use at your own risk. Always obtain proper authorization.**

---

## Quick Reference

### Common Commands

```bash
# Start interactive mode with pentest tools
python main.py interactive

# List available tools
python main.py tools

# Run specific pentest operation
python main.py ask "Scan 192.168.1.50 for open ports"
python main.py ask "Audit AWS security"
python main.py ask "Check Kubernetes security"

# View audit logs
cat logs/pentest_audit.log | grep "PENTEST_AUDIT"
```

### Configuration Quick Check

```bash
# Verify pentest is enabled
grep -A 5 "pentest:" config/config.yaml

# Check whitelisted targets
grep -A 10 "whitelisted_targets:" config/config.yaml

# View recent pentest operations
tail -n 50 logs/pentest_audit.log
```

---

**Remember: With great power comes great responsibility. Use these tools ethically and legally.**
